<!doctype html><html><head><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-6420772-10','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>GKEクラスターをVPCネイティブで作成する &ndash; gist::ymotongpoo</title><meta name=description property="og:description" content="作業ログ 作成されたクラスターの確認。 $ gcloud container clusters list NAME LOCATION MASTER_VERSION MASTER_IP MACHINE_TYPE NODE_VERSION NUM_NODES STATUS trace-sample us-west1-a 1.19.9-gke.1900 34.83.239.113 e2-medium 1.19.9-gke.1900 3 RUNNING ノードプールの更新。 $ gcloud container node-pools update default-pool --cluster=trace-sample --workload-metadata=GKE_METADATA --zone=us-west1-a Updating node pool default-pool...done. Updated [https://container.googleapis.com/v1/projects/trace-microservices-sample/zones/us-west1-a/clusters/trace-sample/nodePools/default-pool]. 次はKube|A brain dumps by Yoshi Yamaguchi."><meta name=apple-mobile-web-app-title content="gist::ymotongpoo"><link rel=icon href=http://gist.ymotongpoo.devfavicon-64.png><link rel=apple-touch-icon href=http://gist.ymotongpoo.devapple-touch-icon.png><link rel=mask-icon size=any href=http://gist.ymotongpoo.devpinned-icon.svg><meta name=twitter:card content="summary"><meta name=twitter:site content="@ymotongpoo"><meta name=twitter:creator content="@ymotongpoo"><meta name=twitter:title content="GKEクラスターをVPCネイティブで作成する | gist::ymotongpoo"><meta name=twitter:description content="作業ログ 作成されたクラスターの確認。 $ gcloud container clusters list NAME LOCATION MASTER_VERSION MASTER_IP MACHINE_TYPE NODE_VERSION NUM_NODES STATUS trace-sample us-west1-a 1.19.9-gke.1900 34.83.239.113 e2-medium 1.19.9-gke.1900 3 RUNNING ノードプールの更新。 $ gcloud container node-pools update default-pool --cluster=trace-sample --workload-metadata=GKE_METADATA --zone=us-west1-a Updating node pool default-pool...done. Updated [https://container.googleapis.com/v1/projects/trace-microservices-sample/zones/us-west1-a/clusters/trace-sample/nodePools/default-pool]. 次はKube|A brain dumps by Yoshi Yamaguchi."><meta name=twitter:image content="http://gist.ymotongpoo.devtwitter-card.png"><link rel=stylesheet href=/assets/syntax.css><link rel=stylesheet href=/assets/primer-build.css><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/custom_style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=http://gist.ymotongpoo.dev>gist::ymotongpoo</a><div class=UnderlineNav-body><a class=UnderlineNav-item href=/><span>Info</span></a>
<a class=UnderlineNav-item href=/posts/><span>Posts</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">GKEクラスターをVPCネイティブで作成する</div></div><div class=Subhead-description><a href=/tags/google-kubernetes-engine class=muted-link><span class="Label Label--gray">google-kubernetes-engine</span></a>
<a href=/tags/vpc class=muted-link><span class="Label Label--gray">vpc</span></a>
<a href=/tags/kubernetes class=muted-link><span class="Label Label--gray">kubernetes</span></a>
<a href=/tags/network class=muted-link><span class="Label Label--gray">network</span></a><div class=float-md-right><span title="Lastmod: 2021-07-20. Published at: 2021-07-20.">Published: 2021-07-20</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=作業ログ>作業ログ</h2><p>作成されたクラスターの確認。</p><pre><code class=language-console data-lang=console>$ gcloud container clusters list
NAME          LOCATION    MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
trace-sample  us-west1-a  1.19.9-gke.1900  34.83.239.113  e2-medium     1.19.9-gke.1900  3          RUNNING
</code></pre><p>ノードプールの更新。</p><pre><code class=language-console data-lang=console>$ gcloud container node-pools update default-pool --cluster=trace-sample --workload-metadata=GKE_METADATA --zone=us-west1-a
Updating node pool default-pool...done.
Updated [https://container.googleapis.com/v1/projects/trace-microservices-sample/zones/us-west1-a/clusters/trace-sample/nodePools/default-pool].
</code></pre><p>次はKubernetes Secretの作成。</p><pre><code class=language-console data-lang=console>$ kubectl create secret generic cloud-sql-secret \
&gt; --from-literal=username=postgres \
&gt; --from-literal=password=xxxxxxxxxxxxxxxxx \
&gt; --from-literal=database=shoe_database
error: failed to create secret Post &quot;http://localhost:8080/api/v1/namespaces/default/secrets?fieldManager=kubectl-create&quot;: dial tcp [::1]:8080: connect: connection refused
</code></pre><p>前と同じ名前でクラスター作ったけど <code>kubectl</code> がアクセスできない。</p><pre><code class=language-console data-lang=console>$ gcloud container clusters get-credentials trace-sample
Fetching cluster endpoint and auth data.
kubeconfig entry generated for trace-sample.
</code></pre><p>KSAを作成</p><pre><code class=language-console data-lang=console>$ kubectl create serviceaccount cloud-sql-ksa --namespace default
serviceaccount/cloud-sql-ksa created

$ kubectl get serviceaccount --namespace default
NAME            SECRETS   AGE
cloud-sql-ksa   1         12s
default         1         46m
</code></pre><p>GSAは前に作ってあるので、KSAとGSAの紐付けを行う。</p><pre><code class=language-console data-lang=console>$ gcloud iam service-accounts add-iam-policy-binding \
&gt; --role roles/iam.workloadIdentityUser \
&gt; --member &quot;serviceAccount:trace-microservices-sample.svc.id.goog[default/cloud-sql-ksa]&quot; \
&gt; cloud-sql-gsa@trace-microservices-sample.iam.gserviceaccount.com
Updated IAM policy for serviceAccount [cloud-sql-gsa@trace-microservices-sample.iam.gserviceaccount.com].
bindings:
- members:
  - serviceAccount:trace-microservices-sample.svc.id.goog[default/cloud-sql-ksa]
  role: roles/iam.workloadIdentityUser
etag: BwXHhKG7SRo=
version: 1
</code></pre><p>KSAにアノテーションを追加する</p><pre><code class=language-console data-lang=console>$ kubectl annotate serviceaccount cloud-sql-ksa iam.gke.io/gcp-service-account=cloud-sql-ksa@trace-microservices-sample.iam.gserviceaccount.com
serviceaccount/cloud-sql-ksa annotated
</code></pre><p>これで実行してみる</p><pre><code>$ skaffold dev
...(略)...
Waiting for deployments to stabilize...
 - deployment/appservice: 0/3 nodes are available: 3 Insufficient cpu.
    - pod/appservice-5bfd679945-lb924: 0/3 nodes are available: 3 Insufficient cpu.
 - deployment/clientservice: creating container clientservice
    - pod/clientservice-645fcb6957-4rqrk: creating container clientservice
 - deployment/appservice: 0/3 nodes are available: 3 Insufficient cpu.
    - pod/appservice-5bfd679945-lb924: 0/3 nodes are available: 3 Insufficient cpu.
 - deployment/appservice failed. Error: 0/3 nodes are available: 3 Insufficient cpu..
Cleaning up...
...(略)...
</code></pre><pre><code class=language-console data-lang=console>$ kubectl apply -f test.yaml
pod/workload-identity-test created
~/corp/k8stest ☁️ trace-sample

$ kubectl exec -it workload-identity-test --namespace default -- /bin/bash
error: unable to upgrade connection: container not found (&quot;workload-identity-test&quot;)

$ kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
workload-identity-test   1/1     Running   0          41s

$ kubectl exec -it workload-identity-test --namespace default -- /bin/bash
root@workload-identity-test:/# gcloud auth list
                         Credentialed Accounts
ACTIVE  ACCOUNT
*       cloud-sql-ksa@trace-microservices-sample.iam.gserviceaccount.com

To set the active account, run:
    $ gcloud config set account `ACCOUNT`
</code></pre><p>Kubernetesクラスタに対してサービスアカウントのapplyをしてなかったことに気がつく。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloud-sql-ksa</span><span class=w>
</span></code></pre></div><pre><code class=language-console data-lang=console>$ kubectl apply -f service-account.yaml
serviceaccount/cloud-sql-ksa created
</code></pre><p>あらためて実行。</p><pre><code class=language-console data-lang=console>$ skaffold dev
...(略)...
 - deployment/appservice: container cloud-sql-proxy terminated with exit code 1
    - pod/appservice-69d6447d6c-dsmls: container cloud-sql-proxy terminated with exit code 1
      &gt; [appservice-69d6447d6c-dsmls cloud-sql-proxy] 2021/07/16 07:48:01 current FDs rlimit set to 1048576, wanted limit is 8500. Nothing to do here.
      &gt; [appservice-69d6447d6c-dsmls cloud-sql-proxy] 2021/07/16 07:48:02 errors parsing config:
      &gt; [appservice-69d6447d6c-dsmls cloud-sql-proxy]   googleapi: Error 403: The client is not authorized to make this request., notAuthorized
 - deployment/appservice failed. Error: container cloud-sql-proxy terminated with exit code 1.
...(略)...
</code></pre><p>エラーが変わった！！！KSAとGSAの紐付けはちゃんと行ってるので、もう一度アノテーションをしてみる。</p><pre><code class=language-console data-lang=console>$ gcloud iam service-accounts add-iam-policy-binding \
&gt; --role roles/iam.workloadIdentityUser \
&gt; --member &quot;serviceAccount:trace-microservices-sample.svc.id.goog[default/cloud-sql-ksa]&quot; \
&gt; cloud-sql-gsa@trace-microservices-sample.iam.gserviceaccount.com
Updated IAM policy for serviceAccount [cloud-sql-gsa@trace-microservices-sample.iam.gserviceaccount.com].
bindings:
- members:
  - serviceAccount:trace-microservices-sample.svc.id.goog[default/cloud-sql-ksa]
  role: roles/iam.workloadIdentityUser
etag: BwXHiYx_cVc=
version: 1

$ kubectl annotate serviceaccount cloud-sql-ksa iam.gke.io/gcp-service-account=cloud-sql-gsa@trace-microservices-sample.iam.gserviceaccount.com
serviceaccount/cloud-sql-ksa annotated
</code></pre><p>再度実行</p><pre><code class=language-console data-lang=console>$ skaffold dev
...(略)...
Waiting for deployments to stabilize...
 - deployment/appservice: waiting for rollout to finish: 0 of 1 updated replicas are available...
 - deployment/clientservice: waiting for rollout to finish: 0 of 1 updated replicas are available...
 - deployment/appservice is ready. [1/2 deployment(s) still pending]
 - deployment/clientservice is ready.
Deployments stabilized in 18.977 seconds
Press Ctrl+C to exit
Watching for changes...
[clientservice]  * Serving Flask app 'main' (lazy loading)
[clientservice]  * Environment: production
[clientservice]    WARNING: This is a development server. Do not use it in a production deployment.
[clientservice]    Use a production WSGI server instead.
[clientservice]  * Debug mode: off
[clientservice]  * Running on all addresses.
[clientservice]    WARNING: This is a development server. Do not use it in a production deployment.
[clientservice]  * Running on http://10.0.0.8:8080/ (Press CTRL+C to quit)
[clientservice] 10.0.0.1 - - [20/Jul/2021 09:07:45] &quot;GET /healthz HTTP/1.1&quot; 200 -
[appservice] 10.0.2.1 - - [20/Jul/2021 09:07:46] &quot;GET /healthz HTTP/1.1&quot; 200 -
[appservice] 10.0.0.11 - - [20/Jul/2021 09:07:55] &quot;GET / HTTP/1.1&quot; 200 -
[clientservice] [{&quot;shoe_id&quot;: 0, &quot;name&quot;: &quot;lemon-furud-1901&quot;, &quot;last_arrival&quot;: &quot;2011-08-02T01:58:21&quot;, &quot;stock&quot;: 192}, {&quot;shoe_id&quot;: 1, &quot;name&quot;: &quot;orange-deneb-2190&quot;, &quot;last_arrival&quot;: &quot;2020-04-02T10:54:26&quot;, &quot;stock&quot;: 98}, {&quot;shoe_id&quot;: 2, &quot;name&quot;: &quot;banana-gomeisa-2129&quot;, &quot;last_arrival&quot;: &quot;2001-01-10T07:39:43&quot;, &quot;stock&quot;: 99}, {&quot;shoe_id&quot;: 3, &quot;name&quot;: &quot;orange-enif-2083&quot;, &quot;last_arrival&quot;: &quot;1988-02-27T16:12:57&quot;, &quot;stock&quot;: 134}, {&quot;shoe_id&quot;: 4, &quot;name&quot;: &quot;orange-atlas-2091&quot;, &quot;last_arrival&quot;: &quot;1980-02-16T11:49:52&quot;, &quot;stock&quot;: 111}, {&quot;shoe_id&quot;: 5, &quot;name&quot;: &quot;orange-deneb-2118&quot;, &quot;last_arrival&quot;: &quot;2001-08-18T03:09:10&quot;, &quot;stock&quot;: 1}, {&quot;shoe_id&quot;: 6, &quot;name&quot;: &quot;banana-enif-1989&quot;, &quot;last_arrival&quot;: &quot;2007-07-03T07:12:42&quot;, &quot;stock&quot;: 56}, {&quot;shoe_id&quot;: 7, &quot;name&quot;: &quot;grape-hamal-2075&quot;, &quot;last_arrival&quot;: &quot;2015-06-20T00:57:25&quot;, &quot;stock&quot;: 69}, {&quot;shoe_id&quot;: 8, &quot;name&quot;: &quot;mango-atlas-2123&quot;, &quot;last_arrival&quot;: &quot;1985-04-08T16:55:27&quot;, &quot;stock&quot;: 106}, {&quot;shoe_id&quot;: 9, &quot;name&quot;: &quot;mango-caph-2135&quot;, &quot;last_arrival&quot;: &quot;1995-08-14T07:44:49&quot;, &quot;stock&quot;: 135}]
...(略)...
</code></pre><p>無事に起動した！！</p><h2 id=まとめ>まとめ</h2><p>はじめからそうなんだけど、GKEからCloud SQLをCloud SQL ProxyとWorkload Identityを使ってつなぐ場合には、公式ドキュメントどおりに設定していけばいい。</p><ul><li><a href=https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine>Connecting from Google Kubernetes Engine</a></li></ul><p>結局気をつけておくことは</p><ul><li>GKEクラスターをVPCネイティブで作っておく（あとから変えられない）</li><li>Kubernetes Service Accountのapplyを忘れない<ul><li><code>kubectl annotate serviceaccount</code> はエラー無しで動いてしまうので気をつける</li></ul></li><li>Cloud SQL Proxyは結構マシンパワーを使うので強めのインスタンスでオートスケール設定しといたほうが無難</li></ul></section><section></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>GKEクラスターをVPCネイティブで作成する</b><nav id=TableOfContents><ul><li><a href=#作業ログ>作業ログ</a></li><li><a href=#まとめ>まとめ</a></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width=61 height=20 style=border:none;overflow:hidden scrolling=no frameborder=0 allowtransparency=true allow=encrypted-media></iframe>
<a href=http://b.hatena.ne.jp/entry/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-label-counter data-hatena-bookmark-lang=ja title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"><span class="text-small text-gray">©Yoshi Yamaguchi 2021- &#183;
Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</span></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>